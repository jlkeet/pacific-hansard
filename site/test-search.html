<!DOCTYPE html>
<html>
<head>
    <title>Test Search Functionality</title>
    <script src="js/jquery-3.4.1.min.js"></script>
    <style>
        body { padding: 20px; font-family: Arial; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; max-height: 400px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Search Functionality Test</h1>
    
    <div class="test-section">
        <h2>1. Test Direct Solr Access (Port 8983)</h2>
        <button onclick="testDirectSolr()">Test Direct Solr</button>
        <pre id="direct-solr-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. Test Solr Through Nginx Proxy</h2>
        <button onclick="testProxySolr()">Test Proxy Solr</button>
        <pre id="proxy-solr-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. Test Simple Search Query</h2>
        <input type="text" id="search-term" placeholder="Enter search term" value="parliament">
        <button onclick="testSearch()">Search</button>
        <pre id="search-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>4. Check Solr Core Status</h2>
        <button onclick="checkSolrStatus()">Check Status</button>
        <pre id="status-result"></pre>
    </div>
    
    <script>
    // Test direct Solr access
    function testDirectSolr() {
        $('#direct-solr-result').html('Testing...');
        $.ajax({
            url: 'http://localhost:8983/solr/hansard_core/select',
            data: {
                q: '*:*',
                rows: 1,
                wt: 'json'
            },
            dataType: 'json',
            success: function(data) {
                $('#direct-solr-result').html(
                    '<span class="success">✓ Direct Solr access works!</span>\n' +
                    'Total documents: ' + data.response.numFound + '\n\n' +
                    'Sample document:\n' + JSON.stringify(data.response.docs[0], null, 2)
                );
            },
            error: function(xhr, status, error) {
                $('#direct-solr-result').html(
                    '<span class="error">✗ Direct Solr access failed</span>\n' +
                    'Status: ' + status + '\n' +
                    'Error: ' + error + '\n\n' +
                    'This is expected if CORS is not enabled on Solr.\n' +
                    'The proxy should work instead.'
                );
            }
        });
    }
    
    // Test Solr through nginx proxy
    function testProxySolr() {
        $('#proxy-solr-result').html('Testing...');
        $.ajax({
            url: '/solr/hansard_core/select',
            data: {
                q: '*:*',
                rows: 1,
                wt: 'json'
            },
            dataType: 'json',
            success: function(data) {
                $('#proxy-solr-result').html(
                    '<span class="success">✓ Proxy Solr access works!</span>\n' +
                    'Total documents: ' + data.response.numFound + '\n\n' +
                    'Sample document:\n' + JSON.stringify(data.response.docs[0], null, 2)
                );
            },
            error: function(xhr, status, error) {
                $('#proxy-solr-result').html(
                    '<span class="error">✗ Proxy Solr access failed</span>\n' +
                    'Status: ' + status + '\n' +
                    'Error: ' + error + '\n' +
                    'Response: ' + xhr.responseText
                );
            }
        });
    }
    
    // Test search functionality
    function testSearch() {
        const searchTerm = $('#search-term').val() || '*:*';
        $('#search-result').html('Searching for: ' + searchTerm + '...');
        
        const searchUrl = '/solr/hansard_core/select?' +
            'q=' + encodeURIComponent(searchTerm) +
            '&fl=id,title,date,source,speaker,speaker2,content,document_type,new_id' +
            '&hl=true&hl.fl=content&hl.snippets=3&hl.fragsize=250' +
            '&rows=5&wt=json';
            
        $.ajax({
            url: searchUrl,
            dataType: 'json',
            success: function(data) {
                let result = '<span class="success">✓ Search works!</span>\n';
                result += 'Found ' + data.response.numFound + ' results\n\n';
                
                if (data.response.docs.length > 0) {
                    result += 'Results:\n';
                    data.response.docs.forEach(function(doc, i) {
                        result += '\n' + (i+1) + '. ' + doc.title + '\n';
                        result += '   Date: ' + doc.date + '\n';
                        result += '   Source: ' + doc.source + '\n';
                        result += '   Speaker: ' + (doc.speaker || 'N/A') + '\n';
                    });
                }
                
                $('#search-result').html(result);
            },
            error: function(xhr, status, error) {
                $('#search-result').html(
                    '<span class="error">✗ Search failed</span>\n' +
                    'Status: ' + status + '\n' +
                    'Error: ' + error + '\n' +
                    'URL: ' + searchUrl + '\n\n' +
                    'Response: ' + xhr.responseText
                );
            }
        });
    }
    
    // Check Solr status
    function checkSolrStatus() {
        $('#status-result').html('Checking...');
        $.ajax({
            url: '/solr/admin/cores?action=STATUS&core=hansard_core',
            dataType: 'json',
            success: function(data) {
                $('#status-result').html(
                    '<span class="success">✓ Solr core status retrieved</span>\n\n' +
                    JSON.stringify(data.status.hansard_core, null, 2)
                );
            },
            error: function(xhr, status, error) {
                $('#status-result').html(
                    '<span class="error">✗ Status check failed</span>\n' +
                    'This might be normal if admin endpoints are protected.\n' +
                    'Status: ' + status + '\n' +
                    'Error: ' + error
                );
            }
        });
    }
    
    // Auto-test on load
    $(document).ready(function() {
        setTimeout(function() {
            testProxySolr();
        }, 500);
    });
    </script>
</body>
</html>